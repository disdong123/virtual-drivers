<html>
<head>
    <style>
        .keyword_label {
            display: none;
        }
        .container {
            display: flex;
            margin: 0 5% 0 0; /* 오른쪽 여백 제거, 왼쪽 여백 5% */
        }
        .address-inputs {
            flex: 0 0 30%; /* 너비 30% 고정 */
            padding: 10px;
            margin-left: 5%; /* 왼쪽 여백 5% */
            background-color: #f9f9f9;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .address-inputs input, .address-inputs div {
            width: 70%; /* 입력 필드 너비 */
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .address-inputs label {
            margin-right: 10px;
            font-weight: bold;
        }
        .address-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .map-container {
            flex: 0 0 70%; /* 너비 70% 고정 */
            padding: 10px;
        }
        .search_button {
            float: none;
            position: static;
            margin-left: 5px;
            width: 48px !important;
            height: 21px !important;
            border: 1px solid #49494b;
            background: #49494b;
            color: #fff;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script src="//d1p7wdleee1q2z.cloudfront.net/post/search.min.js"></script>
</head>
<body>
<h1>지도 테스트</h1>

<div class="container">
    <!-- 주소 입력 부분 -->
    <div class="address-inputs">
        <div>
            <div>출발지</div>
            <div id="start_address_search"></div>
            <div id="start_address"></div>
        </div>
        <div>
            <div>도착지:</div>
            <div id="goal_address_search"></div>
            <div id="goal_address"></div>
        </div>
        <div>
            <button id="direction_button" class="search_button">경로검색</button>
        </div>
    </div>

    <!-- 지도 부분 -->
    <div class="map-container">
        <div id="map" style="width:100%;height:400px;"></div>
    </div>
</div>

<script type="text/javascript" th:src="@{${'https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=' + naverMapProperties.clientId}}"></script>
<script th:inline="javascript">
    const map = new naver.maps.Map('map', {
        center: new naver.maps.LatLng(37.3595704, 127.105399),
        zoom: 10
    });

    let startPosition = null;
    let goalPosition = null;

    $(function() {
        searchAddress(
            "#start_address_search",
            "#start_address",
          "start",
        )
        searchAddress(
            "#goal_address_search",
            "#goal_address",
          "goal"
        )
    });

    $("#direction_button").on("click", () => {
        if(startPosition === null || goalPosition === null) {
            alert("출발지와 도착지를 입력해주세요.")
            return
        }

        fetch(`http://localhost:8080/api/driving-direction?startLatitude=${startPosition.latitude}&startLongitude=${startPosition.longitude}&goalLatitude=${goalPosition.latitude}&goalLongitude=${goalPosition.longitude}`, {
            method: "GET",
        }).then(response => response.json())
          .then(data => {
              if (data.code !== 200) {
                  console.log(data.message)
                  return
              }

              console.log(data.data)
          })
    })

    const searchAddress = (
        searchTagId,
        textTagId,
        type,
    ) => {
        $(searchTagId).postcodify({
            beforeSearch : function(data) {
                $("#entry_box").hide();
            },
            afterSelect: function(data) {
                $(`${searchTagId} div.postcode_search_result`).remove();
                $(`${searchTagId} div.postcode_search_status.summary`).hide();
                $(textTagId).text(data.prevObject.context.innerText)

                setCenterOnMap(data.prevObject.context.innerText, type)
            },
        });
    }

    const setCenterOnMap = (address, type) => {
        fetch(`http://localhost:8080/api/driving-direction/position-test?address=${address}`, {
            method: "GET",
        }).then(response => response.json())
            .then(data => {
                if(data.code !== 200) {
                    console.log(data.message)
                    return
                }

                new naver.maps.Marker({
                    position: new naver.maps.LatLng(data.data.latitude, data.data.longitude),
                    map: map
                })

                map.setCenter(new naver.maps.LatLng(data.data.latitude, data.data.longitude))

                switch (type) {
                    case "start":
                        startPosition = {
                            latitude: data.data.latitude,
                            longitude: data.data.longitude,
                        };
                        break
                    case "goal":
                        goalPosition = {
                            latitude: data.data.latitude,
                            longitude: data.data.longitude,
                        };
                        break
                }
            })
            .catch(error => console.log(error))
    }
</script>
</body>
</html>